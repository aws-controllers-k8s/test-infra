{% for service in aws_services  %}
  aws-controllers-k8s/{{ service }}-controller:
  - name: {{ service }}-kind-e2e
    decorate: true
    optional: false
    always_run: true
    labels:
      preset-dind-enabled: "true"
      preset-kind-volume-mounts: "true"
    extra_refs:
    - org: aws-controllers-k8s
      repo: code-generator
      base_ref: main
      workdir: false
    - org: aws-controllers-k8s
      repo: test-infra
      base_ref: main
      workdir: true
    spec:
      serviceAccountName: pre-submit-service-account
      containers:
      - image: public.ecr.aws/m5q3e4b2/prow:prow-integration-0.0.5
        securityContext:
          privileged: true
        resources:
          requests:
            cpu: 2
          limits:
            cpu: 8
        env:
        - name: SERVICE
          value: {{ service }}
        - name: DUMP_CONTROLLER_LOGS
          value: "true"
        - name: ENABLE_E2E_TESTS
          value: "true"
        - name: ENABLE_HELM_CHART_TEST
          value: "false"
        command: ["wrapper.sh", "bash", "-c", "make kind-test SERVICE=$SERVICE"]

  - name: {{ service }}-release-test
    decorate: true
    optional: false
    always_run: true
    labels:
      preset-dind-enabled: "true"
      preset-kind-volume-mounts: "true"
    extra_refs:
    - org: aws-controllers-k8s
      repo: code-generator
      base_ref: main
      workdir: false
    - org: aws-controllers-k8s
      repo: test-infra
      base_ref: main
      workdir: true
    spec:
      serviceAccountName: pre-submit-service-account
      containers:
      - image: public.ecr.aws/m5q3e4b2/prow:prow-integration-0.0.5
        securityContext:
          privileged: true
        resources:
          requests:
            cpu: 2
          limits:
            cpu: 8
        env:
        - name: SERVICE
          value: {{ service }}
        - name: DUMP_CONTROLLER_LOGS
          value: "true"
        - name: ENABLE_E2E_TESTS
          value: "false"
        - name: ENABLE_HELM_CHART_TEST
          value: "true"
        command: ["wrapper.sh", "bash", "-c", "make kind-test SERVICE=$SERVICE"]

  - name: {{ service }}-recommended-policy-test
    decorate: true
    optional: false
    always_run: true
    extra_refs:
    - org: aws-controllers-k8s
      repo: test-infra
      base_ref: main
      workdir: true
    spec:
      serviceAccountName: pre-submit-service-account
      containers:
      - image: public.ecr.aws/m5q3e4b2/prow:prow-integration-0.0.5
        env:
        - name: SERVICE
          value: {{ service }}
        command: ["bash", "-c", "./scripts/test-recommended-policy.sh"]

  - name: {{ service }}-unit-test
    decorate: true
    optional: false
    always_run: true
    spec:
      serviceAccountName: pre-submit-service-account
      containers:
      - image: public.ecr.aws/m5q3e4b2/prow:prow-unit-0.0.1
        resources:
          limits:
            cpu: 2
        env:
        - name: SERVICE
          value: {{ service }}
        command: ["make", "test"]

{% endfor %}